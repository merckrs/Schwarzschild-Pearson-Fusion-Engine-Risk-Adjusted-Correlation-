//@version=5
indicator("Schwarzschild-Pearson Fusion Engine", shorttitle="SPF Engine", overlay=false)

// --- 1. ENGINEERING PARAMETERS ---
anchorSymbol = input.symbol("NASDAQ:QQQ", title="Anchor Symbol (Reference)", group="Physics Engine", tooltip="The benchmark asset to compare against (e.g., SPY, QQQ, BTCUSDT).")
period = input.int(20, title="Analysis Period (Bars)", minval=5, group="Physics Engine")
g_base = input.float(1.5, title="Base Gravity (G)", step=0.1, group="Physics Engine", tooltip="Higher G makes the filter looser. Lower G makes it stricter.")
density_thresh = input.float(0.01, title="Volume Veto Threshold (%)", step=0.001, tooltip="Vetoes the asset if its Volume Density is below this % of the Anchor.", group="Safety Gate")

// --- 2. DATA FETCHING ---
// Candidate (Chart) Data
c_close = close
c_vol = volume
c_ret = ta.change(c_close) / c_close[1]

// Anchor (Reference) Data
[a_close, a_vol] = request.security(anchorSymbol, timeframe.period, [close, volume])
a_ret = ta.change(a_close) / a_close[1]

// --- 3. ADAPTIVE GRAVITY (G_DYN) ---
// Market Entropy: Standard deviation of the Anchor
market_entropy = ta.stdev(a_ret, period) * 100
// G drops as volatility increases (Tighter Filter in chaos)
g_dyn = g_base / (market_entropy + 0.1)

// --- 4. VOLUMETRIC MASS CALCULATION ---
// Dollar Volume Density
c_dvol = ta.sma(c_close * c_vol, period)
a_dvol = ta.sma(a_close * a_vol, period)

// Density Ratio (Candidate / Anchor)
density_ratio = c_dvol / a_dvol

// --- 5. SCHWARZSCHILD CALCULATIONS ---
// Variance (Reliability)
var_c = ta.variance(c_ret, period)
var_a = ta.variance(a_ret, period)

// Prevent divide by zero
safe_var_c = var_c == 0 ? 1e-9 : var_c
safe_var_a = var_a == 0 ? 1e-9 : var_a

// Mass = Structural Mass + Volumetric Mass
// Candidate Mass
m_struct_c = math.log(period / safe_var_c)
m_vol_c = math.log(density_ratio + 1e-9)

// Volume Veto: If density is too low, penalize mass heavily (-50)
is_vetoed = density_ratio < density_thresh
m_total_c = is_vetoed ? (m_struct_c - 50.0) : (m_struct_c + (m_vol_c * 0.5))

// Anchor Mass (Reference) -> Vol Ratio is 1.0 (log(1)=0)
m_struct_a = math.log(period / safe_var_a)
m_total_a = m_struct_a 

// Mass Difference (Gravitational Potential Difference)
mass_diff = math.abs(m_total_a - m_total_c)

// --- 6. METRIC & EVENT HORIZON ---
// Correlation (Pearson)
corr = ta.correlation(c_ret, a_ret, period)
abs_corr = math.abs(corr)

// Event Horizon Function (Exponential Decay)
horizon = math.exp(-mass_diff / (2 * g_dyn))

// Schwarzschild Distance (Psi)
// As horizon approaches 0, Distance approaches Infinity
psi = (1 - abs_corr) / (horizon + 1e-12)

// --- 7. VISUALIZATION (COCKPIT) ---
// Color Palette
col_safe = color.new(#00ff00, 20)   // Green (Safe)
col_risk = color.new(#ff9800, 20)   // Orange (Risk)
col_danger = color.new(#ff0000, 20) // Red (Danger)
col_veto = color.new(#555555, 0)    // Gray (Veto/Ghost)

// Psi Color Logic
psi_color = is_vetoed ? col_veto : (psi < 0.5 ? col_safe : (psi < 1.0 ? col_risk : col_danger))

// Plot Metric
plot(psi, title="Schwarzschild Distance (Psi)", color=psi_color, linewidth=2, style=plot.style_line)

// Threshold Lines
h1 = hline(0.5, "Safe Zone", color=color.gray, linestyle=hline.style_dotted)
h2 = hline(1.0, "Event Horizon", color=color.red, linestyle=hline.style_solid)
fill(h1, h2, color=color.new(color.red, 90))

// Background Warning (Veto Active)
bgcolor(is_vetoed ? color.new(color.gray, 80) : na, title="Volume Veto Active")

// Dashboard Panel
var table panel = table.new(position.top_right, 2, 4, border_width=1)
if barstate.islast
    table.cell(panel, 0, 0, "Metric", bgcolor=color.gray, text_color=color.white)
    table.cell(panel, 1, 0, "Value", bgcolor=color.gray, text_color=color.white)
    
    table.cell(panel, 0, 1, "Distance (Psi)", bgcolor=psi_color)
    table.cell(panel, 1, 1, str.tostring(psi, "#.##"), bgcolor=psi_color)
    
    table.cell(panel, 0, 2, "Density %", bgcolor=color.black)
    table.cell(panel, 1, 2, str.tostring(density_ratio * 100, "#.##") + "%", bgcolor=color.black, text_color=color.white)
    
    table.cell(panel, 0, 3, "G Factor", bgcolor=color.black)
    table.cell(panel, 1, 3, str.tostring(g_dyn, "#.##"), bgcolor=color.black, text_color=color.white)
